# ============================================================================
# Pipeline Template: What-If Analysis
# ============================================================================
# This template runs az deployment what-if to preview changes
# ============================================================================

parameters:
  - name: applicationName
    type: string
    displayName: 'Application Name'
  
  - name: environment
    type: string
    displayName: 'Environment'
    values:
      - dev
      - test
      - uat
      - prod
  
  - name: azureLocation
    type: string
    displayName: 'Azure Location'
    default: 'eastus'
  
  - name: azureServiceConnection
    type: string
    displayName: 'Azure Service Connection'
  
  - name: templateFile
    type: string
    displayName: 'Template File Path'
    default: 'applications/step/main.bicep'
  
  - name: parameterFile
    type: string
    displayName: 'Parameter File Path'
    default: ''
  
  - name: deploymentScope
    type: string
    displayName: 'Deployment Scope'
    default: 'subscription'
    values:
      - subscription
      - resourceGroup
      - managementGroup
      - tenant
  
  - name: resourceGroupName
    type: string
    displayName: 'Resource Group Name (for RG scope)'
    default: ''
  
  - name: resultFormat
    type: string
    displayName: 'What-If Result Format'
    default: 'ResourceIdOnly'
    values:
      - ResourceIdOnly
      - FullResourcePayloads

steps:
  - task: AzureCLI@2
    displayName: 'What-If Analysis'
    inputs:
      azureSubscription: ${{ parameters.azureServiceConnection }}
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        echo "==============================================="
        echo "What-If Analysis - Preview Changes"
        echo "==============================================="
        echo "Application: ${{ parameters.applicationName }}"
        echo "Environment: ${{ parameters.environment }}"
        echo "Location: ${{ parameters.azureLocation }}"
        echo "Scope: ${{ parameters.deploymentScope }}"
        echo ""
        
        # Set parameter file path
        PARAM_FILE="${{ parameters.parameterFile }}"
        if [ -z "$PARAM_FILE" ]; then
          PARAM_FILE="applications/${{ parameters.applicationName }}/${{ parameters.environment }}/${{ parameters.environment }}.bicepparam"
        fi
        
        echo "Template: ${{ parameters.templateFile }}"
        echo "Parameters: $PARAM_FILE"
        echo "Result Format: ${{ parameters.resultFormat }}"
        echo ""
        
        # Check if files exist
        if [ ! -f "${{ parameters.templateFile }}" ]; then
          echo "Error: Template file not found: ${{ parameters.templateFile }}"
          exit 1
        fi
        
        if [ ! -f "$PARAM_FILE" ]; then
          echo "Error: Parameter file not found: $PARAM_FILE"
          exit 1
        fi
        
        # Run what-if based on deployment scope
        echo "Running what-if analysis..."
        echo ""
        
        case "${{ parameters.deploymentScope }}" in
          subscription)
            az deployment sub what-if \
              --location "${{ parameters.azureLocation }}" \
              --template-file "${{ parameters.templateFile }}" \
              --parameters "$PARAM_FILE" \
              --result-format "${{ parameters.resultFormat }}" \
              --no-pretty-print > whatif-output.txt 2>&1
            ;;
          
          resourceGroup)
            if [ -z "${{ parameters.resourceGroupName }}" ]; then
              echo "Error: Resource group name is required for resource group scope"
              exit 1
            fi
            
            az deployment group what-if \
              --resource-group "${{ parameters.resourceGroupName }}" \
              --template-file "${{ parameters.templateFile }}" \
              --parameters "$PARAM_FILE" \
              --result-format "${{ parameters.resultFormat }}" \
              --no-pretty-print > whatif-output.txt 2>&1
            ;;
          
          managementGroup)
            az deployment mg what-if \
              --location "${{ parameters.azureLocation }}" \
              --template-file "${{ parameters.templateFile }}" \
              --parameters "$PARAM_FILE" \
              --result-format "${{ parameters.resultFormat }}" \
              --no-pretty-print > whatif-output.txt 2>&1
            ;;
          
          tenant)
            az deployment tenant what-if \
              --location "${{ parameters.azureLocation }}" \
              --template-file "${{ parameters.templateFile }}" \
              --parameters "$PARAM_FILE" \
              --result-format "${{ parameters.resultFormat }}" \
              --no-pretty-print > whatif-output.txt 2>&1
            ;;
        esac
        
        WHATIF_RESULT=$?
        
        # Display results
        echo "==============================================="
        echo "What-If Analysis Results"
        echo "==============================================="
        cat whatif-output.txt
        echo ""
        
        if [ $WHATIF_RESULT -eq 0 ]; then
          echo "‚úì What-If analysis completed successfully"
        else
          echo "‚úó What-If analysis failed"
          exit 1
        fi
  
  - task: AzureCLI@2
    displayName: 'Parse and Summarize Changes'
    inputs:
      azureSubscription: ${{ parameters.azureServiceConnection }}
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        echo "==============================================="
        echo "Change Summary"
        echo "==============================================="
        
        if [ -f "whatif-output.txt" ]; then
          # Count changes by type
          CREATE_COUNT=$(grep -c "Create" whatif-output.txt || echo "0")
          MODIFY_COUNT=$(grep -c "Modify" whatif-output.txt || echo "0")
          DELETE_COUNT=$(grep -c "Delete" whatif-output.txt || echo "0")
          IGNORE_COUNT=$(grep -c "Ignore" whatif-output.txt || echo "0")
          NOCHANGE_COUNT=$(grep -c "NoChange" whatif-output.txt || echo "0")
          
          echo ""
          echo "üìä Change Statistics:"
          echo "  + Create:   $CREATE_COUNT resources"
          echo "  ~ Modify:   $MODIFY_COUNT resources"
          echo "  - Delete:   $DELETE_COUNT resources"
          echo "  = NoChange: $NOCHANGE_COUNT resources"
          echo "  ‚äó Ignore:   $IGNORE_COUNT resources"
          echo ""
          
          TOTAL_CHANGES=$((CREATE_COUNT + MODIFY_COUNT + DELETE_COUNT))
          echo "Total Changes: $TOTAL_CHANGES"
          echo ""
          
          if [ $TOTAL_CHANGES -eq 0 ]; then
            echo "‚ÑπÔ∏è No changes detected. Deployment will not modify any resources."
          elif [ $DELETE_COUNT -gt 0 ]; then
            echo "‚ö†Ô∏è WARNING: This deployment will DELETE $DELETE_COUNT resource(s)!"
            echo "   Please review the what-if output carefully before proceeding."
          else
            echo "‚úì Changes detected. Review the what-if output before deployment."
          fi
        else
          echo "Warning: What-if output file not found"
        fi
  
  - task: PublishPipelineArtifact@1
    displayName: 'Publish What-If Results'
    condition: always()
    inputs:
      targetPath: '$(System.DefaultWorkingDirectory)/whatif-output.txt'
      artifact: 'whatif-results-${{ parameters.environment }}'
      publishLocation: 'pipeline'