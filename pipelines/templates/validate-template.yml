# ============================================================================
# Pipeline Template: Bicep Validation
# ============================================================================
# This template runs az deployment validate against Bicep templates
# ============================================================================

parameters:
  - name: applicationName
    type: string
    displayName: 'Application Name'
  
  - name: environment
    type: string
    displayName: 'Environment'
    values:
      - dev
      - test
      - uat
      - prod
  
  - name: azureLocation
    type: string
    displayName: 'Azure Location'
    default: 'eastus'
  
  - name: azureServiceConnection
    type: string
    displayName: 'Azure Service Connection'
  
  - name: subscriptionId
    type: string
    displayName: 'Azure Subscription ID'
    default: ''
  
  - name: templateFile
    type: string
    displayName: 'Template File Path'
    default: 'applications/step/main.bicep'
  
  - name: parameterFile
    type: string
    displayName: 'Parameter File Path'
    default: ''
  
  - name: deploymentScope
    type: string
    displayName: 'Deployment Scope'
    default: 'subscription'
    values:
      - subscription
      - resourceGroup
      - managementGroup
      - tenant
  
  - name: resourceGroupName
    type: string
    displayName: 'Resource Group Name (for RG scope)'
    default: ''

steps:
  - task: AzureCLI@2
    displayName: 'Check Azure Connectivity'
    inputs:
      azureSubscription: ${{ parameters.azureServiceConnection }}
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        echo "==============================================="
        echo "Checking Azure Connectivity"
        echo "==============================================="
        
        # Show current account
        echo "Current Azure Account:"
        az account show
        
        # Show subscription
        echo ""
        echo "Current Subscription:"
        az account show --query "{Name:name, ID:id, TenantId:tenantId}" -o table
        
        # Verify location
        echo ""
        echo "Verifying location: ${{ parameters.azureLocation }}"
        az account list-locations --query "[?name=='${{ parameters.azureLocation }}'].{Name:name, DisplayName:displayName}" -o table
  
  - task: AzureCLI@2
    displayName: 'Validate Bicep Template'
    inputs:
      azureSubscription: ${{ parameters.azureServiceConnection }}
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        echo "==============================================="
        echo "Validating Bicep Template"
        echo "==============================================="
        echo "Application: ${{ parameters.applicationName }}"
        echo "Environment: ${{ parameters.environment }}"
        echo "Location: ${{ parameters.azureLocation }}"
        echo "Scope: ${{ parameters.deploymentScope }}"
        echo "Template: ${{ parameters.templateFile }}"
        echo ""
        
        # Set parameter file path
        PARAM_FILE="${{ parameters.parameterFile }}"
        if [ -z "$PARAM_FILE" ]; then
          PARAM_FILE="applications/${{ parameters.applicationName }}/${{ parameters.environment }}/${{ parameters.environment }}.bicepparam"
        fi
        
        echo "Parameter File: $PARAM_FILE"
        echo ""
        
        # Check if files exist
        if [ ! -f "${{ parameters.templateFile }}" ]; then
          echo "Error: Template file not found: ${{ parameters.templateFile }}"
          exit 1
        fi
        
        if [ ! -f "$PARAM_FILE" ]; then
          echo "Error: Parameter file not found: $PARAM_FILE"
          exit 1
        fi
        
        echo "✓ Template and parameter files found"
        echo ""
        
        # Run validation based on deployment scope
        case "${{ parameters.deploymentScope }}" in
          subscription)
            echo "Running subscription-level validation..."
            az deployment sub validate \
              --location "${{ parameters.azureLocation }}" \
              --template-file "${{ parameters.templateFile }}" \
              --parameters "$PARAM_FILE" \
              --output json > validation-output.json
            ;;
          
          resourceGroup)
            if [ -z "${{ parameters.resourceGroupName }}" ]; then
              echo "Error: Resource group name is required for resource group scope"
              exit 1
            fi
            
            echo "Running resource group validation..."
            az deployment group validate \
              --resource-group "${{ parameters.resourceGroupName }}" \
              --template-file "${{ parameters.templateFile }}" \
              --parameters "$PARAM_FILE" \
              --output json > validation-output.json
            ;;
          
          managementGroup)
            echo "Running management group validation..."
            az deployment mg validate \
              --location "${{ parameters.azureLocation }}" \
              --template-file "${{ parameters.templateFile }}" \
              --parameters "$PARAM_FILE" \
              --output json > validation-output.json
            ;;
          
          tenant)
            echo "Running tenant-level validation..."
            az deployment tenant validate \
              --location "${{ parameters.azureLocation }}" \
              --template-file "${{ parameters.templateFile }}" \
              --parameters "$PARAM_FILE" \
              --output json > validation-output.json
            ;;
        esac
        
        VALIDATION_RESULT=$?
        
        echo ""
        if [ $VALIDATION_RESULT -eq 0 ]; then
          echo "✓✓✓ Validation PASSED ✓✓✓"
          echo ""
          echo "Template is valid and ready for deployment"
          
          # Show validation details
          if [ -f "validation-output.json" ]; then
            echo ""
            echo "Validation Details:"
            cat validation-output.json | jq -r '.properties | {provisioningState, timestamp}'
          fi
        else
          echo "✗✗✗ Validation FAILED ✗✗✗"
          echo ""
          echo "Please review the errors above and fix the template"
          exit 1
        fi
  
  - task: PublishPipelineArtifact@1
    displayName: 'Publish Validation Results'
    condition: always()
    inputs:
      targetPath: '$(System.DefaultWorkingDirectory)/validation-output.json'
      artifact: 'validation-results-${{ parameters.environment }}'
      publishLocation: 'pipeline'