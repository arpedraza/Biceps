# ============================================================================
# Pipeline Template: Bicep Deployment
# ============================================================================
# This template deploys Bicep templates to Azure
# ============================================================================

parameters:
  - name: applicationName
    type: string
    displayName: 'Application Name'
  
  - name: environment
    type: string
    displayName: 'Environment'
    values:
      - dev
      - test
      - uat
      - prod
  
  - name: azureLocation
    type: string
    displayName: 'Azure Location'
    default: 'eastus'
  
  - name: azureServiceConnection
    type: string
    displayName: 'Azure Service Connection'
  
  - name: templateFile
    type: string
    displayName: 'Template File Path'
    default: 'applications/step/main.bicep'
  
  - name: parameterFile
    type: string
    displayName: 'Parameter File Path'
    default: ''
  
  - name: deploymentScope
    type: string
    displayName: 'Deployment Scope'
    default: 'subscription'
    values:
      - subscription
      - resourceGroup
      - managementGroup
      - tenant
  
  - name: resourceGroupName
    type: string
    displayName: 'Resource Group Name (for RG scope)'
    default: ''
  
  - name: deploymentName
    type: string
    displayName: 'Deployment Name'
    default: ''
  
  - name: runWhatIf
    type: boolean
    displayName: 'Run What-If Before Deployment'
    default: true
  
  - name: verifyDeployment
    type: boolean
    displayName: 'Verify Deployment After Completion'
    default: true

steps:
  - task: AzureCLI@2
    displayName: 'Pre-Deployment Check'
    inputs:
      azureSubscription: ${{ parameters.azureServiceConnection }}
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        echo "==============================================="
        echo "Pre-Deployment Check"
        echo "==============================================="
        echo "Application: ${{ parameters.applicationName }}"
        echo "Environment: ${{ parameters.environment }}"
        echo "Location: ${{ parameters.azureLocation }}"
        echo "Scope: ${{ parameters.deploymentScope }}"
        echo ""
        
        # Show current context
        echo "Current Azure Context:"
        az account show --query "{Subscription:name, SubscriptionId:id, TenantId:tenantId}" -o table
        echo ""
        
        # Check provider registrations
        echo "Checking required resource providers..."
        REQUIRED_PROVIDERS=("Microsoft.Compute" "Microsoft.Network" "Microsoft.Storage")
        
        for provider in "${REQUIRED_PROVIDERS[@]}"; do
          STATE=$(az provider show --namespace "$provider" --query "registrationState" -o tsv)
          echo "  $provider: $STATE"
          
          if [ "$STATE" != "Registered" ]; then
            echo "  ⚠️ Warning: $provider is not registered"
          fi
        done
        
        echo ""
        echo "✓ Pre-deployment checks completed"
  
  - task: AzureCLI@2
    displayName: 'What-If Analysis (Optional)'
    condition: and(succeeded(), eq('${{ parameters.runWhatIf }}', 'true'))
    inputs:
      azureSubscription: ${{ parameters.azureServiceConnection }}
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        echo "==============================================="
        echo "Running What-If Analysis Before Deployment"
        echo "==============================================="
        
        # Set parameter file path
        PARAM_FILE="${{ parameters.parameterFile }}"
        if [ -z "$PARAM_FILE" ]; then
          PARAM_FILE="applications/${{ parameters.applicationName }}/${{ parameters.environment }}/${{ parameters.environment }}.bicepparam"
        fi
        
        # Run what-if
        case "${{ parameters.deploymentScope }}" in
          subscription)
            az deployment sub what-if \
              --location "${{ parameters.azureLocation }}" \
              --template-file "${{ parameters.templateFile }}" \
              --parameters "$PARAM_FILE"
            ;;
          
          resourceGroup)
            az deployment group what-if \
              --resource-group "${{ parameters.resourceGroupName }}" \
              --template-file "${{ parameters.templateFile }}" \
              --parameters "$PARAM_FILE"
            ;;
          
          managementGroup)
            az deployment mg what-if \
              --location "${{ parameters.azureLocation }}" \
              --template-file "${{ parameters.templateFile }}" \
              --parameters "$PARAM_FILE"
            ;;
          
          tenant)
            az deployment tenant what-if \
              --location "${{ parameters.azureLocation }}" \
              --template-file "${{ parameters.templateFile }}" \
              --parameters "$PARAM_FILE"
            ;;
        esac
        
        echo ""
        echo "✓ What-If analysis completed"
  
  - task: AzureCLI@2
    displayName: 'Deploy to Azure'
    inputs:
      azureSubscription: ${{ parameters.azureServiceConnection }}
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        echo "==============================================="
        echo "Deploying to Azure"
        echo "==============================================="
        
        # Set parameter file path
        PARAM_FILE="${{ parameters.parameterFile }}"
        if [ -z "$PARAM_FILE" ]; then
          PARAM_FILE="applications/${{ parameters.applicationName }}/${{ parameters.environment }}/${{ parameters.environment }}.bicepparam"
        fi
        
        # Set deployment name
        DEPLOYMENT_NAME="${{ parameters.deploymentName }}"
        if [ -z "$DEPLOYMENT_NAME" ]; then
          DEPLOYMENT_NAME="${{ parameters.applicationName }}-${{ parameters.environment }}-$(date +%Y%m%d-%H%M%S)"
        fi
        
        echo "Deployment Name: $DEPLOYMENT_NAME"
        echo "Template: ${{ parameters.templateFile }}"
        echo "Parameters: $PARAM_FILE"
        echo ""
        
        # Record start time
        START_TIME=$(date +%s)
        
        # Run deployment based on scope
        case "${{ parameters.deploymentScope }}" in
          subscription)
            echo "Deploying to subscription scope..."
            az deployment sub create \
              --name "$DEPLOYMENT_NAME" \
              --location "${{ parameters.azureLocation }}" \
              --template-file "${{ parameters.templateFile }}" \
              --parameters "$PARAM_FILE" \
              --output json > deployment-output.json
            ;;
          
          resourceGroup)
            echo "Deploying to resource group: ${{ parameters.resourceGroupName }}..."
            az deployment group create \
              --name "$DEPLOYMENT_NAME" \
              --resource-group "${{ parameters.resourceGroupName }}" \
              --template-file "${{ parameters.templateFile }}" \
              --parameters "$PARAM_FILE" \
              --output json > deployment-output.json
            ;;
          
          managementGroup)
            echo "Deploying to management group scope..."
            az deployment mg create \
              --name "$DEPLOYMENT_NAME" \
              --location "${{ parameters.azureLocation }}" \
              --template-file "${{ parameters.templateFile }}" \
              --parameters "$PARAM_FILE" \
              --output json > deployment-output.json
            ;;
          
          tenant)
            echo "Deploying to tenant scope..."
            az deployment tenant create \
              --name "$DEPLOYMENT_NAME" \
              --location "${{ parameters.azureLocation }}" \
              --template-file "${{ parameters.templateFile }}" \
              --parameters "$PARAM_FILE" \
              --output json > deployment-output.json
            ;;
        esac
        
        DEPLOYMENT_RESULT=$?
        
        # Record end time and calculate duration
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        
        echo ""
        echo "==============================================="
        if [ $DEPLOYMENT_RESULT -eq 0 ]; then
          echo "✓✓✓ Deployment SUCCEEDED ✓✓✓"
          echo "==============================================="
          echo "Deployment Name: $DEPLOYMENT_NAME"
          echo "Duration: ${DURATION}s"
          echo ""
          
          # Show deployment outputs
          if [ -f "deployment-output.json" ]; then
            echo "Deployment Outputs:"
            cat deployment-output.json | jq -r '.properties.outputs // "No outputs"'
            echo ""
          fi
          
          # Save deployment name for subsequent tasks
          echo "$DEPLOYMENT_NAME" > deployment-name.txt
        else
          echo "✗✗✗ Deployment FAILED ✗✗✗"
          echo "==============================================="
          echo "Deployment Name: $DEPLOYMENT_NAME"
          echo "Duration: ${DURATION}s"
          echo ""
          echo "Please check the error messages above"
          exit 1
        fi
  
  - task: AzureCLI@2
    displayName: 'Get Deployment Details'
    condition: succeeded()
    inputs:
      azureSubscription: ${{ parameters.azureServiceConnection }}
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        echo "==============================================="
        echo "Deployment Details"
        echo "==============================================="
        
        if [ -f "deployment-name.txt" ]; then
          DEPLOYMENT_NAME=$(cat deployment-name.txt)
          echo "Deployment Name: $DEPLOYMENT_NAME"
          echo ""
          
          # Get deployment details based on scope
          case "${{ parameters.deploymentScope }}" in
            subscription)
              echo "Getting subscription deployment details..."
              az deployment sub show \
                --name "$DEPLOYMENT_NAME" \
                --query "{Name:name, State:properties.provisioningState, Timestamp:properties.timestamp, Duration:properties.duration}" \
                -o table
              ;;
            
            resourceGroup)
              echo "Getting resource group deployment details..."
              az deployment group show \
                --name "$DEPLOYMENT_NAME" \
                --resource-group "${{ parameters.resourceGroupName }}" \
                --query "{Name:name, State:properties.provisioningState, Timestamp:properties.timestamp, Duration:properties.duration}" \
                -o table
              ;;
            
            managementGroup)
              echo "Getting management group deployment details..."
              az deployment mg show \
                --name "$DEPLOYMENT_NAME" \
                --query "{Name:name, State:properties.provisioningState, Timestamp:properties.timestamp, Duration:properties.duration}" \
                -o table
              ;;
            
            tenant)
              echo "Getting tenant deployment details..."
              az deployment tenant show \
                --name "$DEPLOYMENT_NAME" \
                --query "{Name:name, State:properties.provisioningState, Timestamp:properties.timestamp, Duration:properties.duration}" \
                -o table
              ;;
          esac
        fi
  
  - task: AzureCLI@2
    displayName: 'Verify Deployment'
    condition: and(succeeded(), eq('${{ parameters.verifyDeployment }}', 'true'))
    inputs:
      azureSubscription: ${{ parameters.azureServiceConnection }}
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        echo "==============================================="
        echo "Verifying Deployment"
        echo "==============================================="
        
        # Construct resource group name
        RG_NAME="rg-${{ parameters.applicationName }}-${{ parameters.environment }}-$(echo ${{ parameters.azureLocation }} | cut -c1-3)"
        
        echo "Checking resource group: $RG_NAME"
        
        if az group show --name "$RG_NAME" &> /dev/null; then
          echo "✓ Resource group exists"
          echo ""
          
          # List resources
          echo "Resources in group:"
          az resource list --resource-group "$RG_NAME" --query "[].{Name:name, Type:type, Location:location}" -o table
          echo ""
          
          # Check VMs if compute resources exist
          VM_COUNT=$(az vm list --resource-group "$RG_NAME" --query "length([])" -o tsv)
          echo "Virtual Machines: $VM_COUNT"
          
          if [ "$VM_COUNT" -gt 0 ]; then
            echo ""
            echo "VM Details:"
            az vm list \
              --resource-group "$RG_NAME" \
              --show-details \
              --query "[].{Name:name, Status:powerState, PrivateIP:privateIps, PublicIP:publicIps, Size:hardwareProfile.vmSize}" \
              -o table
          fi
          
          echo ""
          echo "✓ Deployment verification completed"
        else
          echo "⚠️ Warning: Resource group not found: $RG_NAME"
          echo "   This might be expected for certain deployment scopes"
        fi
  
  - task: PublishPipelineArtifact@1
    displayName: 'Publish Deployment Logs'
    condition: always()
    inputs:
      targetPath: '$(System.DefaultWorkingDirectory)'
      artifact: 'deployment-logs-${{ parameters.environment }}'
      publishLocation: 'pipeline'