# ============================================================================
# ENTERPRISE-GRADE AZURE DEVOPS PIPELINE
# Multi-Stage Bicep Infrastructure Deployment
# ============================================================================
# This pipeline provides a comprehensive CI/CD workflow for deploying
# Bicep infrastructure across multiple environments with approval gates,
# validation, and what-if analysis.
# ============================================================================

name: $(Date:yyyyMMdd)$(Rev:.r)

trigger:
  branches:
    include:
      - main
      - develop
      - release/*
  paths:
    include:
      - applications/**
      - modules/**
      - config/**
    exclude:
      - docs/**
      - README.md
      - .github/**

pr:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - applications/**
      - modules/**
      - config/**

# ============================================================================
# Pipeline Parameters
# ============================================================================
parameters:
  - name: applicationName
    displayName: 'Application to Deploy'
    type: string
    default: 'step'
    values:
      - step
      - all
  
  - name: environmentsToDeploy
    displayName: 'Environments to Deploy'
    type: object
    default:
      - dev
      - test
      - uat
      - prod
  
  - name: skipValidation
    displayName: 'Skip Validation Stage'
    type: boolean
    default: false
  
  - name: skipWhatIf
    displayName: 'Skip What-If Analysis'
    type: boolean
    default: false
  
  - name: deploymentMode
    displayName: 'Deployment Mode'
    type: string
    default: 'Standard'
    values:
      - Standard
      - HotFix
      - Rollback

# ============================================================================
# Variable Groups
# ============================================================================
# These variable groups must be created in Azure DevOps Library
# See docs/AZURE_DEVOPS_SETUP.md for detailed instructions
# ============================================================================
variables:
  - group: 'bicep-common'              # Common variables across all environments
  - group: 'bicep-dev'                 # Dev-specific variables
  - group: 'bicep-test'                # Test-specific variables
  - group: 'bicep-uat'                 # UAT-specific variables
  - group: 'bicep-prod'                # Prod-specific variables
  
  # Pipeline-level variables
  - name: vmImageName
    value: 'ubuntu-latest'
  - name: azureLocation
    value: 'eastus'
  - name: deploymentScope
    value: 'subscription'

stages:
  # ==========================================================================
  # STAGE 1: BUILD & LINT
  # ==========================================================================
  - stage: Build_And_Lint
    displayName: 'Build & Lint'
    condition: succeeded()
    
    jobs:
      - job: Lint_Bicep
        displayName: 'Lint Bicep Templates'
        pool:
          vmImage: $(vmImageName)
        
        steps:
          - checkout: self
            displayName: 'Checkout Source Code'
            persistCredentials: true
          
          - template: pipelines/templates/lint-template.yml
            parameters:
              applicationPath: 'applications/${{ parameters.applicationName }}'
              modulesPath: 'modules'
              azureServiceConnection: $(azureServiceConnection)
              workingDirectory: '$(System.DefaultWorkingDirectory)'
      
      - job: Build_Bicep
        displayName: 'Build Bicep Templates'
        dependsOn: Lint_Bicep
        condition: succeeded()
        pool:
          vmImage: $(vmImageName)
        
        steps:
          - checkout: self
            displayName: 'Checkout Source Code'
          
          - task: AzureCLI@2
            displayName: 'Build Bicep to ARM'
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Building Bicep templates to ARM JSON..."
                
                # Create output directory
                mkdir -p $(Build.ArtifactStagingDirectory)/arm-templates
                
                # Build main template
                MAIN_TEMPLATE="applications/${{ parameters.applicationName }}/main.bicep"
                if [ -f "$MAIN_TEMPLATE" ]; then
                  echo "Building: $MAIN_TEMPLATE"
                  az bicep build \
                    --file "$MAIN_TEMPLATE" \
                    --outfile "$(Build.ArtifactStagingDirectory)/arm-templates/main.json"
                  
                  echo "✓ Template built successfully"
                else
                  echo "Error: Main template not found: $MAIN_TEMPLATE"
                  exit 1
                fi
          
          - task: PublishPipelineArtifact@1
            displayName: 'Publish ARM Templates'
            inputs:
              targetPath: '$(Build.ArtifactStagingDirectory)/arm-templates'
              artifact: 'arm-templates'
              publishLocation: 'pipeline'
          
          - task: PublishPipelineArtifact@1
            displayName: 'Publish Bicep Source'
            inputs:
              targetPath: '$(System.DefaultWorkingDirectory)'
              artifact: 'bicep-source'
              publishLocation: 'pipeline'

  # ==========================================================================
  # STAGE 2: VALIDATE
  # ==========================================================================
  - stage: Validate
    displayName: 'Validate Templates'
    dependsOn: Build_And_Lint
    condition: and(succeeded(), eq('${{ parameters.skipValidation }}', 'false'))
    
    jobs:
      - job: Validate_Dev
        displayName: 'Validate Dev Template'
        pool:
          vmImage: $(vmImageName)
        
        steps:
          - checkout: self
          
          - template: pipelines/templates/validate-template.yml
            parameters:
              applicationName: '${{ parameters.applicationName }}'
              environment: 'dev'
              azureLocation: $(azureLocation)
              azureServiceConnection: $(azureServiceConnection-dev)
              templateFile: 'applications/${{ parameters.applicationName }}/main.bicep'
              deploymentScope: $(deploymentScope)
      
      - job: Validate_Test
        displayName: 'Validate Test Template'
        condition: contains('${{ parameters.environmentsToDeploy }}', 'test')
        pool:
          vmImage: $(vmImageName)
        
        steps:
          - checkout: self
          
          - template: pipelines/templates/validate-template.yml
            parameters:
              applicationName: '${{ parameters.applicationName }}'
              environment: 'test'
              azureLocation: $(azureLocation)
              azureServiceConnection: $(azureServiceConnection-test)
              templateFile: 'applications/${{ parameters.applicationName }}/main.bicep'
              deploymentScope: $(deploymentScope)
      
      - job: Validate_UAT
        displayName: 'Validate UAT Template'
        condition: contains('${{ parameters.environmentsToDeploy }}', 'uat')
        pool:
          vmImage: $(vmImageName)
        
        steps:
          - checkout: self
          
          - template: pipelines/templates/validate-template.yml
            parameters:
              applicationName: '${{ parameters.applicationName }}'
              environment: 'uat'
              azureLocation: $(azureLocation)
              azureServiceConnection: $(azureServiceConnection-uat)
              templateFile: 'applications/${{ parameters.applicationName }}/main.bicep'
              deploymentScope: $(deploymentScope)
      
      - job: Validate_Prod
        displayName: 'Validate Prod Template'
        condition: contains('${{ parameters.environmentsToDeploy }}', 'prod')
        pool:
          vmImage: $(vmImageName)
        
        steps:
          - checkout: self
          
          - template: pipelines/templates/validate-template.yml
            parameters:
              applicationName: '${{ parameters.applicationName }}'
              environment: 'prod'
              azureLocation: $(azureLocation)
              azureServiceConnection: $(azureServiceConnection-prod)
              templateFile: 'applications/${{ parameters.applicationName }}/main.bicep'
              deploymentScope: $(deploymentScope)

  # ==========================================================================
  # STAGE 3: WHAT-IF PREVIEW
  # ==========================================================================
  - stage: Preview
    displayName: 'What-If Preview'
    dependsOn: Validate
    condition: and(succeeded(), eq('${{ parameters.skipWhatIf }}', 'false'))
    
    jobs:
      - job: Preview_All_Environments
        displayName: 'Preview Changes for All Environments'
        pool:
          vmImage: $(vmImageName)
        
        strategy:
          matrix:
            Dev:
              environmentName: 'dev'
              serviceConnection: $(azureServiceConnection-dev)
            Test:
              environmentName: 'test'
              serviceConnection: $(azureServiceConnection-test)
            UAT:
              environmentName: 'uat'
              serviceConnection: $(azureServiceConnection-uat)
            Prod:
              environmentName: 'prod'
              serviceConnection: $(azureServiceConnection-prod)
        
        steps:
          - checkout: self
          
          - template: pipelines/templates/whatif-template.yml
            parameters:
              applicationName: '${{ parameters.applicationName }}'
              environment: $(environmentName)
              azureLocation: $(azureLocation)
              azureServiceConnection: $(serviceConnection)
              templateFile: 'applications/${{ parameters.applicationName }}/main.bicep'
              deploymentScope: $(deploymentScope)
              resultFormat: 'ResourceIdOnly'

  # ==========================================================================
  # STAGE 4: DEPLOY TO DEVELOPMENT
  # ==========================================================================
  - stage: Deploy_Dev
    displayName: 'Deploy to Development'
    dependsOn:
      - Build_And_Lint
      - Validate
      - Preview
    condition: and(succeeded(), contains('${{ parameters.environmentsToDeploy }}', 'dev'))
    
    variables:
      - group: 'bicep-dev'
      - name: environment
        value: 'dev'
    
    jobs:
      - deployment: Deploy_Infrastructure
        displayName: 'Deploy Dev Infrastructure'
        pool:
          vmImage: $(vmImageName)
        environment: 'Development'
        
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                
                - template: pipelines/templates/deploy-template.yml
                  parameters:
                    applicationName: '${{ parameters.applicationName }}'
                    environment: 'dev'
                    azureLocation: $(azureLocation)
                    azureServiceConnection: $(azureServiceConnection-dev)
                    templateFile: 'applications/${{ parameters.applicationName }}/main.bicep'
                    deploymentScope: $(deploymentScope)
                    runWhatIf: false
                    verifyDeployment: true

  # ==========================================================================
  # STAGE 5: DEPLOY TO TEST
  # ==========================================================================
  - stage: Deploy_Test
    displayName: 'Deploy to Test'
    dependsOn: Deploy_Dev
    condition: and(succeeded(), contains('${{ parameters.environmentsToDeploy }}', 'test'))
    
    variables:
      - group: 'bicep-test'
      - name: environment
        value: 'test'
    
    jobs:
      - deployment: Deploy_Infrastructure
        displayName: 'Deploy Test Infrastructure'
        pool:
          vmImage: $(vmImageName)
        environment: 'Test'
        
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                
                - template: pipelines/templates/deploy-template.yml
                  parameters:
                    applicationName: '${{ parameters.applicationName }}'
                    environment: 'test'
                    azureLocation: $(azureLocation)
                    azureServiceConnection: $(azureServiceConnection-test)
                    templateFile: 'applications/${{ parameters.applicationName }}/main.bicep'
                    deploymentScope: $(deploymentScope)
                    runWhatIf: true
                    verifyDeployment: true

  # ==========================================================================
  # STAGE 6: DEPLOY TO UAT
  # ==========================================================================
  - stage: Deploy_UAT
    displayName: 'Deploy to UAT'
    dependsOn: Deploy_Test
    condition: and(succeeded(), contains('${{ parameters.environmentsToDeploy }}', 'uat'))
    
    variables:
      - group: 'bicep-uat'
      - name: environment
        value: 'uat'
    
    jobs:
      - deployment: Deploy_Infrastructure
        displayName: 'Deploy UAT Infrastructure'
        pool:
          vmImage: $(vmImageName)
        environment: 'UAT'  # REQUIRES MANUAL APPROVAL
        
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                
                - template: pipelines/templates/deploy-template.yml
                  parameters:
                    applicationName: '${{ parameters.applicationName }}'
                    environment: 'uat'
                    azureLocation: $(azureLocation)
                    azureServiceConnection: $(azureServiceConnection-uat)
                    templateFile: 'applications/${{ parameters.applicationName }}/main.bicep'
                    deploymentScope: $(deploymentScope)
                    runWhatIf: true
                    verifyDeployment: true

  # ==========================================================================
  # STAGE 7: DEPLOY TO PRODUCTION
  # ==========================================================================
  - stage: Deploy_Prod
    displayName: 'Deploy to Production'
    dependsOn: Deploy_UAT
    condition: and(succeeded(), contains('${{ parameters.environmentsToDeploy }}', 'prod'))
    
    variables:
      - group: 'bicep-prod'
      - name: environment
        value: 'prod'
    
    jobs:
      - deployment: Deploy_Infrastructure
        displayName: 'Deploy Production Infrastructure'
        pool:
          vmImage: $(vmImageName)
        environment: 'Production'  # REQUIRES MANUAL APPROVAL
        
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                
                - task: ManualValidation@0
                  displayName: 'Final Production Approval'
                  inputs:
                    notifyUsers: ''
                    instructions: |
                      ⚠️ PRODUCTION DEPLOYMENT
                      
                      Please review:
                      1. What-If analysis results from Preview stage
                      2. Test and UAT deployment results
                      3. Change management tickets
                      
                      Approve only if all validations passed.
                    onTimeout: 'reject'
                
                - template: pipelines/templates/deploy-template.yml
                  parameters:
                    applicationName: '${{ parameters.applicationName }}'
                    environment: 'prod'
                    azureLocation: $(azureLocation)
                    azureServiceConnection: $(azureServiceConnection-prod)
                    templateFile: 'applications/${{ parameters.applicationName }}/main.bicep'
                    deploymentScope: $(deploymentScope)
                    runWhatIf: true
                    verifyDeployment: true
      
      - job: Post_Deployment_Verification
        displayName: 'Post-Deployment Verification'
        dependsOn: Deploy_Infrastructure
        condition: succeeded()
        pool:
          vmImage: $(vmImageName)
        
        steps:
          - checkout: self
          
          - task: AzureCLI@2
            displayName: 'Verify Production Deployment'
            inputs:
              azureSubscription: $(azureServiceConnection-prod)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "==============================================="
                echo "Production Deployment Verification"
                echo "==============================================="
                
                RG_NAME="rg-${{ parameters.applicationName }}-prod-$(echo $(azureLocation) | cut -c1-3)"
                
                echo "Verifying resource group: $RG_NAME"
                
                # Check resource group
                if az group show --name "$RG_NAME" &> /dev/null; then
                  echo "✓ Resource group exists"
                  
                  # List all resources
                  echo ""
                  echo "Deployed Resources:"
                  az resource list \
                    --resource-group "$RG_NAME" \
                    --query "[].{Name:name, Type:type, Location:location, Status:provisioningState}" \
                    -o table
                  
                  # Check VM status
                  VM_COUNT=$(az vm list --resource-group "$RG_NAME" --query "length([])" -o tsv)
                  echo ""
                  echo "Virtual Machines: $VM_COUNT"
                  
                  if [ "$VM_COUNT" -gt 0 ]; then
                    echo ""
                    echo "VM Status:"
                    az vm list \
                      --resource-group "$RG_NAME" \
                      --show-details \
                      --query "[].{Name:name, PowerState:powerState, ProvisioningState:provisioningState}" \
                      -o table
                    
                    # Check for failed VMs
                    FAILED_VMS=$(az vm list \
                      --resource-group "$RG_NAME" \
                      --show-details \
                      --query "[?provisioningState!='Succeeded'].name" \
                      -o tsv)
                    
                    if [ ! -z "$FAILED_VMS" ]; then
                      echo ""
                      echo "⚠️ Warning: Some VMs are not in Succeeded state:"
                      echo "$FAILED_VMS"
                      exit 1
                    fi
                  fi
                  
                  echo ""
                  echo "✓✓✓ Production verification completed successfully ✓✓✓"
                else
                  echo "✗ Error: Resource group not found"
                  exit 1
                fi
          
          - task: AzureCLI@2
            displayName: 'Tag Resources with Deployment Info'
            inputs:
              azureSubscription: $(azureServiceConnection-prod)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Tagging resources with deployment information..."
                
                RG_NAME="rg-${{ parameters.applicationName }}-prod-$(echo $(azureLocation) | cut -c1-3)"
                
                az group update \
                  --name "$RG_NAME" \
                  --tags \
                    LastDeployment="$(Build.BuildNumber)" \
                    LastDeploymentDate="$(date +%Y-%m-%d)" \
                    PipelineId="$(Build.DefinitionName)" \
                    DeployedBy="$(Build.RequestedFor)"
                
                echo "✓ Resources tagged successfully"